#!/bin/bash

readonly LNG=${LNG:=en_US}
readonly URL="http://translate.google.com/translate_tts?ie=UTF-8&tl=${LNG}&q="
readonly STOCK="${HOME}/.${0##*/}"

urlencode() {
    python2 <<EOF
# coding=utf-8
import urllib, sys
words='''$*'''.split()
line=""
for word in words:
    word+=" "
    if len(word) + len(line) >= 100:
        sys.stdout.write(urllib.quote(line) + ' ')
        line=word
    else:
        line+=word
sys.stdout.write(urllib.quote(line))
EOF
}

which mpg123 &>/dev/null || {
echo "error: mpg123 not installed"
exit 1
}

which curl &>/dev/null || {
echo "error: curl not installed"
exit 1
}

for chunk in $(urlencode "$@"); do
    curl -s -A Mozilla -o "${STOCK}" "${URL}${chunk}"
    mpg123 "${STOCK}" &>/dev/null
    rm -f "${STOCK}"
done
